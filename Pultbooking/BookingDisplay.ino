/**
   BasicHTTPSClient.ino

    Created on: 20.08.2018

*/

#include <Arduino.h>

#include <ESP8266WiFi.h>
#include <ESP8266WiFiMulti.h>
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <ESP8266HTTPClient.h>

#include <WiFiClientSecureBearSSL.h>

// OLED FeatherWing buttons map to different pins depending on board.
// The I2C (Wire) bus may also be different.
#if defined(ESP8266)
  #define BUTTON_A  0
  #define BUTTON_B 16
  #define BUTTON_C  2
  #define WIRE Wire
#elif defined(ESP32)
  #define BUTTON_A 15
  #define BUTTON_B 32
  #define BUTTON_C 14
  #define WIRE Wire
#elif defined(ARDUINO_STM32_FEATHER)
  #define BUTTON_A PA15
  #define BUTTON_B PC7
  #define BUTTON_C PC5
  #define WIRE Wire
#elif defined(TEENSYDUINO)
  #define BUTTON_A  4
  #define BUTTON_B  3
  #define BUTTON_C  8
  #define WIRE Wire
#elif defined(ARDUINO_FEATHER52832)
  #define BUTTON_A 31
  #define BUTTON_B 30
  #define BUTTON_C 27
  #define WIRE Wire
#elif defined(ARDUINO_ADAFRUIT_FEATHER_RP2040)
  #define BUTTON_A  9
  #define BUTTON_B  8
  #define BUTTON_C  7
  #define WIRE Wire1
#else // 32u4, M0, M4, nrf52840 and 328p
  #define BUTTON_A  9
  #define BUTTON_B  6
  #define BUTTON_C  5
  #define WIRE Wire
#endif

const char *my_string[] = {\
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b11000000,0b00011100,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b11100000,0b00111100,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000111,0b11100000,0b11111100,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000111,0b11000111,0b11110000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000111,0b10000111,0b11100000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b01000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000011,0b11111111,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b11000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000001,0b11111111,0b00000000,0b00111110,0b11111111,0b11101111,0b11111001,0b11111100,0b00000000,0b11000000,0b01111111,0b11110111,0b11111100,0b00000000,\n" \
"0b00000000,0b00000000,0b00000001,0b11111100,0b00000000,0b01111000,0b11111111,0b10001111,0b11100001,0b11111110,0b00000000,0b11000000,0b11111111,0b11000111,0b11110000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000001,0b11111111,0b00000000,0b00001000,0b00000100,0b00010010,0b00000010,0b11000011,0b00000000,0b11100000,0b00000110,0b00000001,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000001,0b11111111,0b00000000,0b00011000,0b00001100,0b00000110,0b00000000,0b11000011,0b00000000,0b11100000,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00001111,0b11100111,0b11100000,0b00011000,0b00001100,0b00000110,0b00000000,0b11000011,0b00000001,0b01100000,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00011111,0b11000001,0b11100000,0b00011000,0b00001100,0b00000111,0b00000000,0b11000010,0b00000001,0b00110000,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b01111111,0b11000001,0b11100000,0b00011000,0b00001100,0b00000111,0b11000000,0b11001100,0b00000010,0b00110000,0b00000110,0b00000111,0b11100000,0b00000000,\n" \
"0b00000000,0b00000000,0b01111111,0b11111000,0b11100000,0b00011000,0b00001100,0b00001110,0b00000000,0b11111100,0b00001010,0b00111000,0b00000110,0b00000111,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00111111,0b11111111,0b11100000,0b00011000,0b00001100,0b00000110,0b00000000,0b11000110,0b00011111,0b11011000,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b00011111,0b10111111,0b11100000,0b00011000,0b00001100,0b00000110,0b00000000,0b11000111,0b00000100,0b00011100,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b00011111,0b11111111,0b10000000,0b00011000,0b00001100,0b00000110,0b00000000,0b10000011,0b00001100,0b00001100,0b00000110,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b00011111,0b11111111,0b00000000,0b00010000,0b00001100,0b00000110,0b00000000,0b10000011,0b10001000,0b00001100,0b00000100,0b00000011,0b00000000,0b00000000,\n" \
"0b00000000,0b00001111,0b00000111,0b11111111,0b00000000,0b00010000,0b00001000,0b00000100,0b00000000,0b10000001,0b10010000,0b00000110,0b00000100,0b00000010,0b00000100,0b00000000,\n" \
"0b00000000,0b00001111,0b00000111,0b11111111,0b11000000,0b00111110,0b00011110,0b00001111,0b11110001,0b01110001,0b11111100,0b00000111,0b00001111,0b00000111,0b11111000,0b00000000,\n" \
"0b00000000,0b00001111,0b00000011,0b11111111,0b11100000,0b00111100,0b00111100,0b00001111,0b11110011,0b11100000,0b11111000,0b00000011,0b00011110,0b00000111,0b11111000,0b00000000,\n" \
"0b00000000,0b00000111,0b00001111,0b11111001,0b11100000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b11111111,0b11111111,0b11111000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b11111111,0b11111110,0b01111000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000111,0b11111110,0b11111110,0b01111000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b11110000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,\n" \
"0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000\n"};

const static char* root_ca PROGMEM = \
    "-----BEGIN CERTIFICATE-----\n" \
    "MIIDbzCCAlegAwIBAgIQFFJQ86V2DO0TbKbP7o96aTANBgkqhkiG9w0BAQsFADBL\n" \
    "MRAwDgYDVQQKEwdBY21lIENvMTcwNQYDVQQDEy5LdWJlcm5ldGVzIEluZ3Jlc3Mg\n" \
    "Q29udHJvbGxlciBGYWtlIENlcnRpZmljYXRlMB4XDTIyMDgxMTIwNDYzNloXDTIz\n" \
    "MDgxMTIwNDYzNlowSzEQMA4GA1UEChMHQWNtZSBDbzE3MDUGA1UEAxMuS3ViZXJu\n" \
    "ZXRlcyBJbmdyZXNzIENvbnRyb2xsZXIgRmFrZSBDZXJ0aWZpY2F0ZTCCASIwDQYJ\n" \
    "KoZIhvcNAQEBBQADggEPADCCAQoCggEBAMuYMZUsy7E5Ynu+XzL2gOeu0BdLLwzR\n" \
    "gdrh1aN0v1BqqfarbOcJvmyTItu98m51b7rt59O6LRgRC+3ZZ5twm9nB28GiiREj\n" \
    "0Bklp92fJs8dTaS2ZXHXJSxZAzkP2e9AtIAX5ZYDO6Y2R0CnDLhqofQVKM4AsIi0\n" \
    "oFIiiSWovjsrKqFawkfeHUaHweMVQoLHwyL7eAWm+vMPu1jWOdF5NS70YTxLhfX/\n" \
    "U2fU2eUKq8YjHlV7T/K8LP6gUFgTzijFGSyxYPXGfqn+ck1a9squ3ksdQkpbY/A1\n" \
    "cMyMlw/3+0Ziz6Hi2JjMeFwjtH5cvgoYs6dqVkPEhQGs58jXheyWmR8CAwEAAaNP\n" \
    "ME0wDgYDVR0PAQH/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMBMAwGA1UdEwEB\n" \
    "/wQCMAAwGAYDVR0RBBEwD4INaW5ncmVzcy5sb2NhbDANBgkqhkiG9w0BAQsFAAOC\n" \
    "AQEAUbVtWwU/NUyKtLPBrCIzDJoe9RSmQEcD+tg0AOnLhiyT+JXInHl/O5Uisybq\n" \
    "+wL5r4WHl3ZCVWbPJ9OwFIc9Hfc6PIQTTsEFLyEzDbm3gzSVbhREGIwqCp+zl8Ct\n" \
    "ptWpuK2nQZA7j0t7fveziVl1bucU337nJwNWiRkdsaQgJxDoP5ejkN3QJQS0JFwp\n" \
    "DAaMAZNPqhMsfCbOvghQWK6iEtZdIZucBZBhVDF0AGqnETnt4kvVQzSbKkpGJ9ro\n" \
    "WbzDPGnVXw4gQ5PBWiiQQOAL5frrSmlX5xFKlwEjZm8Q/I56DNqz9q2NnJAiUv5h\n" \
    "sg1E4ylPCQOyQ9zaja/9CfNINA==\n" \
    "-----END CERTIFICATE-----";

ESP8266WiFiMulti WiFiMulti;
Adafruit_SSD1306 display = Adafruit_SSD1306(128, 32, &WIRE);

uint8_t atou8(const char *s)
{
  uint8_t v = 0;
      while (*s) { v = (v << 1) + (v << 3) + (*(s++) - '0'); }
      return v;
}

void setup() {

  const uint8_t converted_value = atou8(my_string[0]);

  Serial.begin(115200);
  // Serial.setDebugOutput(true);

  Serial.println();
  Serial.println(converted_value);
  Serial.println();

  for (uint8_t t = 4; t > 0; t--) {
    Serial.printf("[SETUP] WAIT %d...\n", t);
    Serial.flush();
    delay(1000);
  }

  // Show image buffer on the display hardware.
  // Since the buffer is intialized with an Adafruit splashscreen
  // internally, this will display the splashscreen.
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C); // Address 0x3C for 128x32
  Serial.println("OLED begun");

  display.display();
  delay(1000);

  // Clear the buffer.
  display.clearDisplay();
  display.display();

  WiFi.mode(WIFI_STA);
  WiFiMulti.addAP("IterateG17Guest", "woopwoop");
}

void loop() {
  // wait for WiFi connection
  if ((WiFiMulti.run() == WL_CONNECTED)) {

    std::unique_ptr<BearSSL::WiFiClientSecure> client(new BearSSL::WiFiClientSecure);

    //client.setCACert(root_ca);
    //client->setFingerprint(fingerprint);
    // Or, if you happy to ignore the SSL certificate, then use the following line instead:
    client->setInsecure();

    HTTPClient https;

    Serial.print("[HTTPS] begin...\n");
    if (https.begin(*client, "https://meet-the-backend.app.iterate.no/api/v1/esp/desk/sloyden_desk_6")) {  // HTTPS

      Serial.print("[HTTPS] GET...\n");
      // start connection and send HTTP header
      int httpCode = https.GET();

      // httpCode will be negative on error
      if (httpCode > 0) {
        // HTTP header has been send and Server response header has been handled
        Serial.printf("[HTTPS] GET... code: %d\n", httpCode);

        // file found at server
        if (httpCode == HTTP_CODE_OK || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
          String payload = https.getString();
          //Serial.println(https);
          display.setTextSize(1);
          display.setTextColor(SSD1306_WHITE);
          display.setCursor(0,0);
          display.clearDisplay();
          delay(200);
          display.println(payload);
          //display.setCursor(0,0);
          display.display(); // actually display all of the above
          //display.drawBitmap(0, 0, reinterpret_cast<const uint8_t*>(&my_string[0]), 64, 32, WHITE);
          //display.drawBitmap(0, 0,my_string, 128, 32, WHITE);
          display.display();
        }
      } else {
        Serial.printf("[HTTPS] GET... failed, error: %s\n", https.errorToString(httpCode).c_str());
      }

      https.end();
    } else {
      Serial.printf("[HTTPS] Unable to connect\n");
    }
  }

  Serial.println("Wait 10s before next round...");
  delay(10000);
}
